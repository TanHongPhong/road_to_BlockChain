<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Giám sát Nhiệt độ</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

    <style>
      body{font-family:"Inter",sans-serif;background:#f5f7fa}
      .custom-scrollbar::-webkit-scrollbar{width:6px}
      .custom-scrollbar::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
      .custom-scrollbar::-webkit-scrollbar-thumb{background:#d1d5db;border-radius:10px}
      .custom-scrollbar::-webkit-scrollbar-thumb:hover{background:#9ca3af}
      canvas{width:100%!important;height:320px!important}
    </style>
  </head>

  <body class="text-gray-800">
    <div class="min-h-screen p-5">
      <header class="mb-5 flex flex-wrap items-center justify-between gap-4">
        <div class="flex items-center gap-2">
          <i data-feather="activity" class="h-6 w-6 text-blue-600"></i>
          <h1 class="text-2xl font-bold text-gray-900">Giám sát nhiệt độ</h1>
        </div>

        <div class="flex items-center gap-4">
          <div class="flex items-center gap-3 px-4 py-2 bg-white rounded-lg border border-gray-200 shadow-sm">
            <div>
              <div class="text-xs text-gray-500">Nhiệt độ hiện tại</div>
              <div id="current-temp" class="text-gray-900 font-semibold">—°C</div>
            </div>
            <div class="h-8 w-px bg-gray-200"></div>
            <div>
              <div class="text-xs text-gray-500">Trung bình</div>
              <div id="avg-temp" class="text-gray-900 font-semibold">—°C</div>
            </div>
            <div class="h-8 w-px bg-gray-200"></div>
            <div>
              <div class="text-xs text-gray-500">Min/Max</div>
              <div id="min-max-temp" class="text-gray-900 font-semibold">—°C / —°C</div>
            </div>
          </div>

          <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg px-6 h-10 flex items-center gap-2">
            <i data-feather="file-text" class="h-4 w-4"></i> Báo cáo
          </button>
        </div>
      </header>

      <main class="grid grid-cols-1 lg:grid-cols-[360px_1fr] gap-5">
        <div class="flex flex-col gap-5">
          <div class="sticky [top:calc(var(--topbar-h,64px)+16px)]" style="--topbar-h:64px">
            <div class="max-h-[calc(100dvh-var(--topbar-h,64px)-2rem)] overflow-y-auto pr-1">
              <div class="bg-white border border-slate-200 rounded-2xl p-3 relative">
                <div class="sticky top-0 z-10 -m-3 p-3 bg-white/95 backdrop-blur rounded-t-2xl border-b border-slate-200">
                  <div class="flex items-center justify-between gap-3">
                    <h3 class="font-semibold tracking-tight">ORDER SEARCH</h3>
                    <div class="relative flex-1">
                      <input id="search-input" class="h-9 w-full rounded-lg border border-slate-300 pl-8 pr-3 text-sm placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Tìm kiếm"/>
                      <i data-feather="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                    </div>
                  </div>
                </div>
                <article class="mt-3 rounded-xl border border-blue-200 bg-blue-50/40 p-3">
                  <div class="flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2 flex-1 min-w-0 overflow-hidden">
                      <span class="inline-grid place-items-center w-8 h-8 rounded-lg bg-blue-100 text-[#1E66FF]"><i data-feather="truck" class="w-4 h-4"></i></span>
                      <div class="text-sm min-w-0">
                        <div class="flex items-center gap-2 flex-wrap">
                          <span class="font-semibold text-slate-800">ShipID-0123</span>
                          <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-100 text-[#1E66FF] ring-1 ring-blue-200/70">ARRIVING</span>
                        </div>
                        <div class="text-[11px] text-slate-500 leading-snug">
                          <div>DL04MP7045</div>
                          <div class="whitespace-nowrap">Tải trọng tối đa 6.5 tấn</div>
                        </div>
                      </div>
                    </div>
                    <button class="shrink-0 w-8 h-8 rounded-full grid place-items-center bg-[#1E66FF] text-white ring-1 ring-blue-500/30 hover:brightness-105">
                      <i data-feather="eye" class="w-4 h-4"></i>
                    </button>
                  </div>
                </article>
                <div id="vehicle-list" class="mt-3 space-y-3"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex flex-col h-[calc(100dvh-140px)] min-h-0 overflow-hidden">
          <div class="flex flex-col gap-5 overflow-y-auto pr-2 -mr-2 custom-scrollbar flex-1 min-h-0 h-full">
            <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
              <div class="mb-4 flex items-center justify-between">
                <div>
                  <h3 class="font-bold text-gray-900 mb-1">Nhiệt độ khu vực</h3>
                  <div class="text-sm text-gray-500">Biểu đồ nhiệt độ theo thời gian</div>
                </div>
                <div id="status" class="text-xs text-gray-500"></div>
              </div>
              <canvas id="chart"></canvas>
              <div id="time-range-selector" class="flex items-center justify-center gap-2 mt-4 pt-4 border-t border-gray-200"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-5">
              <div class="md:col-span-3 p-4 bg-white border border-gray-200 rounded-lg shadow-sm min-w-0">
                <h3 class="font-bold text-gray-900 mb-4">Lịch sử thay đổi nhiệt độ</h3>
                <div class="space-y-3">
                  <div class="grid grid-cols-[140px_130px_1fr_90px_90px] gap-3 pb-2 border-b border-gray-200 text-sm font-semibold text-gray-600">
                    <div>Thời gian</div><div>Mã xe</div><div>Tuyến đường</div><div>Nhiệt độ</div><div>Biến động</div>
                  </div>
                  <div id="history-list"></div>
                </div>
              </div>
              <div class="md:col-span-2 p-4 bg-white border border-gray-200 rounded-lg shadow-sm min-w-0">
                <h3 class="font-bold text-gray-900 mb-4">Cảnh báo nhiệt độ</h3>
                <div id="alert-list" class="space-y-3"></div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      const ESP_BASE = "http://10.150.88.110";
      const POLL_MS = 2000;
      const MAX_POINTS = 300;

      const chartData = { labels: [], temps: [] };
      let chart = null;
      let timeRange = "1h";

      const commonOptions = {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#1f2937',
            bodyColor: '#1f2937',
            borderColor: '#e5e7eb',
            borderWidth: 1,
            padding: 12,
            displayColors: true,
            callbacks: {
              label: function(context) {
                return 'Nhiệt độ: ' + context.parsed.y.toFixed(2) + '°C';
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 11 } },
            grid: { color: '#e5e7eb', drawBorder: false }
          },
          y: {
            ticks: { color: '#9ca3af', font: { size: 11 }, callback: v => v.toFixed(1) + '°C' },
            grid: { color: '#e5e7eb', drawBorder: false }
          }
        }
      };

      function initChart() {
        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('chart'), {
          type: 'line',
          data: {
            labels: chartData.labels,
            datasets: [{
              label: 'Nhiệt độ (°C)',
              data: chartData.temps,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.15)',
              borderWidth: 2.5,
              pointRadius: 0,
              pointHoverRadius: 0,
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            ...commonOptions,
            scales: {
              ...commonOptions.scales,
              y: {
                ...commonOptions.scales.y,
                suggestedMin: 20,
                suggestedMax: 35
              }
            }
          }
        });
      }

      function updateKpis() {
        if (!chartData.temps.length) {
          document.getElementById("current-temp").textContent = "—°C";
          document.getElementById("avg-temp").textContent = "—°C";
          document.getElementById("min-max-temp").textContent = "—°C / —°C";
          return;
        }
        const cur = chartData.temps[chartData.temps.length - 1];
        const avg = chartData.temps.reduce((s, v) => s + v, 0) / chartData.temps.length;
        const min = Math.min(...chartData.temps);
        const max = Math.max(...chartData.temps);
        document.getElementById("current-temp").textContent = `${cur.toFixed(1)}°C`;
        document.getElementById("avg-temp").textContent = `${avg.toFixed(1)}°C`;
        document.getElementById("min-max-temp").textContent = `${min.toFixed(1)}°C / ${max.toFixed(1)}°C`;
      }

      function renderTimeRangeButtons() {
        const container = document.getElementById("time-range-selector");
        const ranges = [
          {label:"1 giờ", value:"1h"},
          {label:"6 giờ", value:"6h"},
          {label:"12 giờ", value:"12h"},
          {label:"24 giờ", value:"24h"},
          {label:"7 ngày", value:"7d"},
        ];
        container.innerHTML = ranges.map(r=>`
          <button data-range="${r.value}"
            class="time-range-btn px-4 py-1.5 rounded-lg text-sm transition-colors ${timeRange===r.value?"bg-blue-600 text-white font-semibold":"bg-gray-100 text-gray-600 hover:bg-gray-200"}">
            ${r.label}
          </button>`).join("");

        container.addEventListener("click", (e) => {
          const b = e.target.closest(".time-range-btn");
          if (!b) return;
          timeRange = b.dataset.range;
          document.querySelectorAll(".time-range-btn").forEach(btn => {
            const act = btn === b;
            btn.classList.toggle("bg-blue-600", act);
            btn.classList.toggle("text-white", act);
            btn.classList.toggle("font-semibold", act);
            btn.classList.toggle("bg-gray-100", !act);
            btn.classList.toggle("text-gray-600", !act);
            btn.classList.toggle("hover:bg-gray-200", !act);
          });
        });
      }

      async function pollDevice() {
        const status = document.getElementById("status");
        try {
          const r = await fetch(`${ESP_BASE}/api/now`, { cache: "no-store" });
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const j = await r.json();
          const t = Number(j.t);
          if (!Number.isNaN(t)) {
            const label = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            chartData.labels.push(label);
            chartData.temps.push(t);
            if (chartData.labels.length > MAX_POINTS) {
              chartData.labels.shift();
              chartData.temps.shift();
            }
            status.textContent = `OK @ ${new Date().toLocaleTimeString()} | t=${t.toFixed(1)}°C`;
            if (chart) {
              chart.data.labels = chartData.labels;
              chart.data.datasets[0].data = chartData.temps;
              chart.update('none');
            }
            updateKpis();
          } else {
            status.textContent = "Dữ liệu không hợp lệ";
          }
        } catch (e) {
          console.warn(e);
          status.textContent = "Không lấy được dữ liệu";
        }
      }

      const vehicles = [
        { id:"Truck #A123", route:"TP.HCM → Hà Nội", status:"running" },
        { id:"Truck #B456", route:"Đà Nẵng → Huế", status:"running" },
        { id:"Truck #C789", route:"Hà Nội → Hải Phòng", status:"paused" },
      ];

      function renderVehicles() {
        const q = (document.getElementById("search-input").value || "").toLowerCase();
        const container = document.getElementById("vehicle-list");
        container.innerHTML = vehicles
          .filter(v => v.id.toLowerCase().includes(q) || v.route.toLowerCase().includes(q))
          .map(v=>`
          <article class="mt-3 rounded-xl border border-blue-200 bg-blue-50/40 p-3">
            <div class="flex items-center justify-between gap-2">
              <div class="flex items-center gap-2 flex-1 min-w-0 overflow-hidden">
                <span class="inline-grid place-items-center w-8 h-8 rounded-lg bg-blue-100 text-[#1E66FF]">
                  <i data-feather="truck" class="w-4 h-4"></i>
                </span>
                <div class="text-sm min-w-0">
                  <div class="flex items-center gap-2 flex-wrap">
                    <span class="font-semibold text-slate-800 truncate">${v.id}</span>
                    <span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-blue-100 text-[#1E66FF] ring-1 ring-blue-200/70">
                      ${v.status==="paused"?"PAUSED":"ARRIVING"}
                    </span>
                  </div>
                  <div class="text-[11px] text-slate-500 leading-snug">
                    <div class="truncate">${v.route}</div>
                    <div class="whitespace-nowrap">Tải trọng tối đa 6.5 tấn</div>
                  </div>
                </div>
              </div>
              <button class="shrink-0 w-8 h-8 rounded-full grid place-items-center bg-[#1E66FF] text-white ring-1 ring-blue-500/30">
                <i data-feather="eye" class="w-4 h-4"></i>
              </button>
            </div>
          </article>`).join("");
        feather.replace();
      }

      document.addEventListener("DOMContentLoaded", () => {
        renderTimeRangeButtons();
        initChart();
        renderVehicles();
        document.getElementById("search-input").addEventListener("input", renderVehicles);
        feather.replace();
        pollDevice();
        setInterval(pollDevice, POLL_MS);
      });
    </script>
  </body>
</html>