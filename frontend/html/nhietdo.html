<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Giám sát Nhiệt độ</title>
    
    <!-- Fonts & Icons --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Feather Icons --><script src="https://unpkg.com/feather-icons"></script>

    <!-- ApexCharts --><script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F7FA;
        }
        /* Custom scrollbar for better look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        .apexcharts-tooltip {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px 12px;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="min-h-screen p-5">
        <!-- Header --><header class="mb-5 flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <i data-feather="activity" class="h-6 w-6 text-blue-600"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Giám sát nhiệt độ</h1>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3 px-4 py-2 bg-white rounded-lg border border-gray-200 shadow-sm">
                    <div>
                        <div class="text-xs text-gray-500">Nhiệt độ hiện tại</div>
                        <div id="current-temp" class="text-gray-900 font-semibold">—°C</div>
                    </div>
                    <div class="h-8 w-px bg-gray-200"></div>
                    <div>
                        <div class="text-xs text-gray-500">Trung bình</div>
                        <div id="avg-temp" class="text-gray-900 font-semibold">—°C</div>
                    </div>
                    <div class="h-8 w-px bg-gray-200"></div>
                    <div>
                        <div class="text-xs text-gray-500">Min/Max</div>
                        <div id="min-max-temp" class="text-gray-900 font-semibold">—°C / —°C</div>
                    </div>
                </div>
                
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg px-6 h-10 flex items-center gap-2">
                    <i data-feather="file-text" class="h-4 w-4"></i>
                    Báo cáo
                </button>
            </div>
        </header>

        <!-- Main Content --><main class="grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-5">
            <!-- Left Column --><div class="flex flex-col gap-5">
                <!-- Chart --><div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <div class="mb-4">
                        <h3 class="font-bold text-gray-900 mb-1">Nhiệt độ khu vực</h3>
                        <div class="text-sm text-gray-500">Biểu đồ nhiệt độ theo thời gian</div>
                    </div>
                    <div id="chart" class="h-[320px]"></div>
                    <div id="time-range-selector" class="flex items-center justify-center gap-2 mt-4 pt-4 border-t border-gray-200">
                        <!-- Buttons will be generated by JS --></div>
                </div>

                <!-- Temperature History --><div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-900 mb-4">Lịch sử thay đổi nhiệt độ</h3>
                    <div class="space-y-3">
                        <div class="grid grid-cols-[140px_130px_1fr_90px_90px] gap-3 pb-2 border-b border-gray-200 text-sm font-semibold text-gray-600">
                            <div>Thời gian</div>
                            <div>Mã xe</div>
                            <div>Tuyến đường</div>
                            <div>Nhiệt độ</div>
                            <div>Biến động</div>
                        </div>
                        <div id="history-list">
                            <!-- History items will be generated by JS --></div>
                    </div>
                </div>
            </div>

            <!-- Right Column --><div class="flex flex-col gap-5">
                <!-- Vehicles List --><div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm flex flex-col max-h-[calc(100vh-140px)]">
                    <h3 class="font-bold text-gray-900 mb-4">Danh sách xe vận chuyển</h3>
                    <div class="relative mb-4">
                        <i data-feather="search" class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"></i>
                        <input id="search-input" type="text" placeholder="Tìm kiếm theo ID hoặc tuyến đường..." class="pl-10 h-10 w-full bg-gray-50 border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="vehicle-list" class="space-y-3 overflow-y-auto flex-1 pr-2 -mr-2 custom-scrollbar">
                        <!-- Vehicle cards will be generated by JS --></div>
                </div>

                <!-- Alerts --><div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                    <h3 class="font-bold text-gray-900 mb-4">Cảnh báo nhiệt độ</h3>
                    <div id="alert-list" class="space-y-3">
                        <!-- Alert items will be generated by JS --></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- MOCK DATA ---
        const generateTemperatureData = (timeRange) => {
            const now = new Date();
            const data = [];
            let points = 0, interval = 0;
            switch (timeRange) {
                case '1h': points = 60; interval = 1; break;
                case '6h': points = 72; interval = 5; break;
                case '12h': points = 72; interval = 10; break;
                case '24h': points = 96; interval = 15; break;
                case '7d': points = 84; interval = 120; break;
            }
            for (let i = points - 1; i >= 0; i--) {
                const time = new Date(now.getTime() - i * interval * 60000);
                // Adjusted mock data to better show different color zones
                const temp = 10 + Math.sin(i / 15) * 8 + Math.random() * 4;
                data.push({
                    time: time.getTime(),
                    temperature: parseFloat(temp.toFixed(1)),
                });
            }
            return data;
        };

        const vehicles = [
            { id: 'Truck #A123', route: 'TP.HCM → Hà Nội', status: 'running', temperature: 4.5 },
            { id: 'Truck #B456', route: 'Đà Nẵng → Huế', status: 'running', temperature: 8.2 },
            { id: 'Truck #C789', route: 'Hà Nội → Hải Phòng', status: 'paused', temperature: 15.8 },
            { id: 'Truck #D012', route: 'Cần Thơ → TP.HCM', status: 'running', temperature: 3.5 },
            { id: 'Truck #E345', route: 'Nha Trang → Quy Nhơn', status: 'running', temperature: 11.9 },
        ];

        const temperatureHistory = [
            { date: '14/10/2025 14:30', vehicle: 'Truck #C789', route: 'Hà Nội → Hải Phòng', temperature: 15.8, change: '+2.3', trend: 'up' },
            { date: '14/10/2025 13:45', vehicle: 'Truck #B456', route: 'Đà Nẵng → Huế', temperature: 8.2, change: '-0.8', trend: 'down' },
            { date: '14/10/2025 12:20', vehicle: 'Truck #E345', route: 'Nha Trang → Quy Nhơn', temperature: 11.9, change: '+1.2', trend: 'up' },
        ];

        const alerts = [
            { time: '14/10/2025 14:36', title: 'Nhiệt độ vượt ngưỡng nguy hiểm', description: 'Truck #C789 (Hà Nội → Hải Phòng) ghi nhận nhiệt độ 15.8°C.', severity: 'high', vehicle: 'Truck #C789' },
            { time: '14/10/2025 13:22', title: 'Cảnh báo nhiệt độ', description: 'Truck #E345 (Nha Trang → Quy Nhơn) có nhiệt độ tăng.', severity: 'medium', vehicle: 'Truck #E345' },
        ];

        // --- STATE & CONFIG ---
        let timeRange = '24h';
        let chart;
        
        // --- HELPERS ---
        const getTemperatureStyle = (temp) => {
            if (temp < 5) return { color: '#3B82F6', bgColor: '#EFF6FF', borderColor: '#93C5FD', status: 'Tốt' };
            if (temp >= 5 && temp < 12) return { color: '#F59E0B', bgColor: '#FFF7ED', borderColor: '#FDBA74', status: 'Cảnh báo' };
            return { color: '#EF4444', bgColor: '#FEF2F2', borderColor: '#FCA5A5', status: 'Nguy hiểm' };
        };

        // --- RENDER FUNCTIONS ---
        function renderTimeRangeButtons() {
            const container = document.getElementById('time-range-selector');
            const ranges = [
                { label: '1 giờ', value: '1h' }, { label: '6 giờ', value: '6h' },
                { label: '12 giờ', value: '12h' }, { label: '24 giờ', value: '24h' },
                { label: '7 ngày', value: '7d' },
            ];
            container.innerHTML = ranges.map(range => `
                <button
                    data-range="${range.value}"
                    class="time-range-btn px-4 py-1.5 rounded-lg text-sm transition-colors ${
                        timeRange === range.value
                        ? 'bg-blue-600 text-white font-semibold'
                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }"
                >
                    ${range.label}
                </button>
            `).join('');
        }

        function renderChart() {
            const chartData = generateTemperatureData(timeRange);
            const seriesData = chartData.map(d => ({ x: d.time, y: d.temperature }));
            const yAxisMax = 25; // Define max Y-axis for consistent gradient mapping

            const options = {
                series: [{ name: 'Nhiệt độ', data: seriesData }],
                chart: {
                    type: 'area',
                    height: 320,
                    toolbar: { show: false },
                    zoom: { enabled: false },
                },
                dataLabels: { enabled: false },
                stroke: { 
                    curve: 'smooth', 
                    width: 2, // Slightly thinner line
                    colors: ['#6B7280'], // Darker line for contrast
                    opacity: 0.6 // Slightly faded line
                },
                fill: {
                    type: 'gradient',
                    gradient: {
                        shade: 'light',
                        type: "vertical",
                        shadeIntensity: 0.1, // Reduced shade intensity for lighter fill
                        inverseColors: false,
                        opacityFrom: 0.4, // Reduced starting opacity
                        opacityTo: 0.1, // Reduced ending opacity
                        colorStops: [
                            {
                                offset: 100 - (12 / yAxisMax * 100), // Red starts from 12°C
                                color: "#EF4444",
                                opacity: 0.4 // Red opacity
                            },
                             {
                                offset: 100 - (5 / yAxisMax * 100), // Orange from 5°C to 12°C
                                color: "#F59E0B",
                                opacity: 0.3 // Orange opacity
                            },
                            {
                                offset: 0, // Blue below 5°C
                                color: "#3B82F6",
                                opacity: 0.2 // Blue opacity
                            }
                        ]
                    }
                },
                xaxis: {
                    type: 'datetime',
                    labels: { style: { colors: '#9CA3AF', fontSize: '12px' } },
                    axisBorder: { show: false },
                    axisTicks: { show: false }
                },
                yaxis: {
                    min: 0,
                    max: yAxisMax,
                    labels: {
                        style: { colors: '#9CA3AF', fontSize: '12px' },
                        formatter: (val) => `${val.toFixed(0)}°C`
                    },
                },
                grid: {
                    borderColor: '#E5E7EB',
                    strokeDashArray: 4
                },
                tooltip: {
                    x: { format: 'HH:mm - dd/MM/yy' },
                    y: {
                        formatter: function(value) {
                            const style = getTemperatureStyle(value);
                            return `<span style="color: ${style.color}; font-weight: 600;">${value.toFixed(1)}°C</span> (${style.status})`
                        }
                    }
                },
            };

            if (chart) {
                chart.updateOptions(options);
            } else {
                chart = new ApexCharts(document.querySelector("#chart"), options);
                chart.render();
            }
            updateKpis(chartData);
        }

        function updateKpis(data) {
            const currentTemp = data[data.length - 1]?.temperature || 0;
            const avgTemp = (data.reduce((sum, d) => sum + d.temperature, 0) / data.length).toFixed(1);
            const minTemp = Math.min(...data.map(d => d.temperature)).toFixed(1);
            const maxTemp = Math.max(...data.map(d => d.temperature)).toFixed(1);
            
            document.getElementById('current-temp').textContent = `${currentTemp.toFixed(1)}°C`;
            document.getElementById('avg-temp').textContent = `${avgTemp}°C`;
            document.getElementById('min-max-temp').textContent = `${minTemp}°C / ${maxTemp}°C`;
        }
        
        function renderVehicles() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const container = document.getElementById('vehicle-list');
            const filtered = vehicles.filter(v => 
                v.id.toLowerCase().includes(query) || v.route.toLowerCase().includes(query)
            );

            if(filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-feather="truck" class="h-12 w-12 mx-auto mb-2 opacity-30"></i>
                        <p>Không tìm thấy xe nào</p>
                    </div>`;
                feather.replace();
                return;
            }

            container.innerHTML = filtered.map(vehicle => {
                const style = getTemperatureStyle(vehicle.temperature);
                return `
                <div class="p-4 bg-white rounded-lg border shadow-sm hover:shadow-md transition-all" style="border-color: ${style.borderColor};">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <div class="p-2 rounded-lg" style="background-color: ${style.bgColor};">
                                <i data-feather="truck" class="h-5 w-5" style="color: ${style.color};"></i>
                            </div>
                            <span class="font-semibold text-gray-900">${vehicle.id}</span>
                        </div>
                        <span class="text-xs font-bold text-white px-2 py-0.5 rounded-full" style="background-color: ${style.color};">${style.status}</span>
                    </div>
                    <div class="flex items-center gap-2 mb-3 text-sm text-gray-500">
                        <i data-feather="map-pin" class="h-4 w-4"></i>
                        <span>${vehicle.route}</span>
                    </div>
                    <div class="p-3 rounded-lg mb-3 text-center" style="background-color: ${style.bgColor};">
                        <div class="text-xs text-gray-500 mb-1">Nhiệt độ thùng hàng</div>
                        <div class="text-3xl font-bold" style="color: ${style.color};">${vehicle.temperature}°C</div>
                    </div>
                    <button class="w-full h-9 rounded-lg border text-sm font-semibold transition-colors"
                        style="border-color: ${style.color}; color: ${style.color};"
                        onmouseenter="this.style.backgroundColor='${style.color}'; this.style.color='white';"
                        onmouseleave="this.style.backgroundColor='transparent'; this.style.color='${style.color}';">
                        Xem chi tiết
                    </button>
                </div>`;
            }).join('');
            feather.replace({ width: 20, height: 20 });
        }

        function renderHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = temperatureHistory.map(item => `
                <div class="grid grid-cols-[140px_130px_1fr_90px_90px] gap-3 py-2 border-b border-gray-100 hover:bg-gray-50 -mx-4 px-4 rounded-lg transition-colors text-sm">
                    <div class="text-gray-600">${item.date}</div>
                    <div class="text-gray-800 font-medium flex items-center gap-1.5">
                        <i data-feather="truck" class="h-3.5 w-3.5 text-gray-500"></i>
                        ${item.vehicle}
                    </div>
                    <div class="text-gray-600">${item.route}</div>
                    <div class="text-gray-800 font-medium">${item.temperature}°C</div>
                    <div class="flex items-center gap-1 font-semibold ${item.trend === 'up' ? 'text-red-500' : 'text-blue-500'}">
                        <i data-feather="${item.trend === 'up' ? 'trending-up' : 'trending-down'}" class="h-4 w-4"></i>
                        <span>${item.change}°C</span>
                    </div>
                </div>
            `).join('');
            feather.replace({ width: 16, height: 16 });
        }
        
        function renderAlerts() {
            const container = document.getElementById('alert-list');
            container.innerHTML = alerts.map(alert => {
                const isHigh = alert.severity === 'high';
                const color = isHigh ? '#EF4444' : '#F59E0B';
                const bgColor = isHigh ? '#FEF2F2' : '#FFF7ED';

                return `
                <div class="p-3 rounded-lg border" style="border-color: ${color}; background-color: ${bgColor};">
                    <div class="flex items-start gap-3">
                        <div class="p-1.5 rounded-lg flex-shrink-0" style="background-color: ${color}20;">
                            <i data-feather="alert-circle" class="h-5 w-5" style="color: ${color};"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <div class="text-xs text-gray-600">${alert.time}</div>
                                <span class="text-xs text-white px-2 py-0.5 rounded-full flex items-center gap-1" style="background-color: ${color};">
                                    <i data-feather="truck" class="h-3 w-3"></i>
                                    ${alert.vehicle}
                                </span>
                            </div>
                            <div class="text-sm font-semibold text-gray-900 mb-1">${alert.title}</div>
                            <div class="text-xs text-gray-600 leading-relaxed">${alert.description}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            feather.replace();
        }

        // --- EVENT LISTENERS & INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            renderTimeRangeButtons();
            renderChart()
            renderVehicles();
            renderHistory();
            renderAlerts();

            document.getElementById('search-input').addEventListener('input', renderVehicles);

            document.getElementById('time-range-selector').addEventListener('click', (e) => {
                const button = e.target.closest('.time-range-btn');
                if (button) {
                    timeRange = button.dataset.range;
                    document.querySelectorAll('.time-range-btn').forEach(btn => {
                        btn.classList.remove('bg-blue-600', 'text-white', 'font-semibold');
                        btn.classList.add('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                    });
                    button.classList.add('bg-blue-600', 'text-white', 'font-semibold');
                    button.classList.remove('bg-gray-100', 'text-gray-600', 'hover:bg-gray-200');
                    renderChart();
                }
            });

            feather.replace();
        });

    </script>
</body>
</html>

